<%- include('_head.html'); %>
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
      <%= title %>
    </h1>
    <% if (true) { %>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2">
        <a href="/" class="btn btn-sm btn-outline-secondary spinner-trigger">Cancel</a>
      </div>
    </div>
    <% } %>
  </div>
  <%- include('_alert.html'); %>
  <div class="row">
    <div class="col-md-5">
      <label for="selUnprovisioned" class="mb-1">Unprovisioned Agents</label>
      <input type="text" class="form-control mb-2" placeholder="Search Agent..." id="txtSearchAgent">
      <select size="15" multiple name="selUnprovisioned" id="selUnprovisioned" class="form-select">
        <% unprovisionedAgents.forEach(function(agents){%>
        <option value="<%=agents.agentId%>"><%=agents.agentName%></option>
        <%});%>
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col-md-5 mt-3">
      <button type="button" class="btn btn-success" id="btnProvision">&rightarrow; Provision Selected Agents</button>
    </div>
  </div>
</main>
<script>
  document.addEventListener("DOMContentLoaded", async (eDOMContentLoaded) => {
    const SLEEP_MS = 1500;
    let selUnprovisioned = document.getElementById('selUnprovisioned');
    let btnProvision = document.getElementById('btnProvision');
    txtSearchAgent.addEventListener("keyup", (ev) => {
      filterOptions(ev.target.value, selUnprovisioned.getElementsByTagName('option'));
    }); // txtSearchAgent.addEventListener("keyup")
    btnProvision.addEventListener("click", async (evClickBtnSave) => {
      if (!selUnprovisioned.selectedOptions.length) {
        alert("No Agent Selected");
        return;
      }
      show_loader()
      for (let i = 0; i < selUnprovisioned.selectedOptions.length; i++) {
        let agentId = selUnprovisioned.selectedOptions[i].value;
        let agentName = selUnprovisioned.selectedOptions[i].text;
        let response = await fetch(`/agent-provision/provision-agent?agentid=${agentId}&agentname=${agentName}`);
        await sleep(SLEEP_MS);
      } // next selUnprovisioned.selectedOptions[i]
      hide_loader();
      window.location.replace('/agent-provision/provision-agent-success')
    }); // btnProvision.addEventListener("click")
  }); //document.addEventListener("DOMContentLoaded")
</script>
<%- include('_foot.html'); %>